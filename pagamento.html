<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pagamento — FUTMARKET BR</title>
  <style>
    body{margin:0;font-family:sans-serif;background:linear-gradient(180deg,#0a74ff,#1161d6);color:#fff;}
    .topbar{background:#0b0b0b;padding:14px 24px;color:#fff;font-weight:700;}
    .wrap{max-width:1000px;margin:40px auto;padding:20px;}
    h1{text-align:center;font-size:32px;margin-bottom:30px;}
    .steps{display:flex;justify-content:center;gap:60px;margin-bottom:30px;}
    .step{display:flex;flex-direction:column;align-items:center;font-size:14px;font-weight:600;color:#ccc;}
    .circle{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;margin-bottom:6px;border:2px solid #ccc;}
    .step.active{color:#fff;}
    .step.active .circle{background:#0a74ff;border-color:#0a74ff;color:#fff;}
    .step.done{color:#fff;}
    .step.done .circle{background:#fff;color:#000;border-color:#fff;}
    .card{background:#0b2035;padding:20px;border-radius:10px;margin-bottom:20px;cursor:pointer;}
    .card.disabled{opacity:0.5;cursor:not-allowed;}
    .summary{margin-top:30px;text-align:right;font-size:20px;font-weight:bold;}
    .btn-pix{display:block;background:#ffd400;color:#000;text-align:center;font-weight:700;padding:14px;border-radius:8px;margin-top:20px;text-decoration:none;}
    /* --- popup qr --- */
    .overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:9999;display:none;}
    .popup{background:#fff;color:#000;padding:20px;border-radius:10px;text-align:center;max-width:300px;}
    .popup img{width:200px;height:200px;}
    .popup button{margin-top:10px;padding:8px 16px;border:none;background:#0a74ff;color:#fff;font-weight:bold;border-radius:6px;cursor:pointer;}
  </style>
</head>
<body>
  <div class="topbar">FUTMARKET BR</div>
  <div class="wrap">
    <div class="steps">
      <div class="step done"><div class="circle">1</div>Plataforma</div>
      <div class="step done"><div class="circle">2</div>Método</div>
      <div class="step done"><div class="circle">3</div>Quantia</div>
      <div class="step active"><div class="circle">4</div>Pagamento</div>
    </div>
    <h1>Escolha a forma de pagamento</h1>

    <div class="card" id="pixCard">
      <h3>FAÇA UM PIX</h3>
      <p>Pague com um clique via PIX</p>
    </div>

    <div class="card disabled">
      <h3>CARTÃO DE CRÉDITO OU DÉBITO</h3>
      <p>Em manutenção</p>
    </div>

    <div class="summary">
      Coins a receber: <span id="coins"></span><br>
      Valor: <span id="price"></span>
    </div>

    <a href="#" id="btnPix" class="btn-pix">Pagar com PIX</a>
  </div>

  <!-- popup qr -->
  <div class="overlay" id="overlay">
    <div class="popup">
      <h3>Escaneie o QR PIX</h3>
      <img id="qrImage" src="" alt="QR PIX">
      <p id="copyCode"></p>
      <button onclick="fecharPopup()">Fechar</button>
    </div>
  </div>

  <script>
    const coins = localStorage.getItem('order_coins') || '';
    const price = localStorage.getItem('order_price') || '';
    document.getElementById('coins').textContent = coins;
    document.getElementById('price').textContent = price;

    async function criarCheckoutPix(valor, descricao) {
      const res = await fetch("/api/pix-checkout", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ amount: valor, description: descricao })
      });
      return await res.json();
    }

    document.getElementById('btnPix').addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        const valor = parseFloat(price.replace("R$","").replace(".","").replace(",",".").trim());
        const descricao = coins + " coins FUTMARKET BR";

        const data = await criarCheckoutPix(valor, descricao);

        if(data && data.qr_code_base64){ 
          document.getElementById("qrImage").src = "data:image/png;base64," + data.qr_code_base64;
          document.getElementById("copyCode").textContent = data.qr_code || "";
          document.getElementById("overlay").style.display = "flex";
        } else {
          alert("Erro ao gerar o PIX.");
          console.log(data);
        }
      } catch (err) {
        alert("Erro na comunicação com o servidor.");
        console.error(err);
      }
    });

    function fecharPopup(){
      document.getElementById("overlay").style.display = "none";
    }
  </script>
</body>
</html>
